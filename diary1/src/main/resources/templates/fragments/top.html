<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="top">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <div class="input-group">
                <button type="button" id="sidebarCollapse" class="btn btn-primary" style="margin-right: 15px">
                    <i class="fa fa-bars"></i> <span class="sr-only">Toggle Menu</span>
                </button>
                <input id="searchInput" type="text" class="form-control bg-light border-0 small"
                    placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button id="searchBtn" class="btn btn-primary" type="button">
                        <i class="bi bi-search"></i> ê²€ìƒ‰
                    </button>
                </div>
            </div>
        </div>
    </nav>
    <div id="searchResult" class="mt-3"></div>

    <script>
        document.getElementById("searchBtn").addEventListener("click", function () {
            const keyword = document.getElementById("searchInput").value.trim();
            const searchType = "group";  // ê·¸ë£¹ë§Œ ê²€ìƒ‰í•˜ë„ë¡ ê³ ì •
            
            if (!keyword) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            console.log("ê²€ìƒ‰ì–´:", keyword);  // ê²€ìƒ‰ì–´ í™•ì¸

            fetch(`/search/${searchType}/${encodeURIComponent(keyword)}`)  // URLì— ê²€ìƒ‰ ìœ í˜• ì¶”ê°€
            .then(response => response.json())
            .then(data => {
                console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);  // ì„œë²„ ì‘ë‹µ ë°ì´í„° í™•ì¸
                const resultDiv = document.getElementById("searchResult");

                if (data.status === "success") {
                    let html = "<h5>ğŸ” ê²€ìƒ‰ ê²°ê³¼</h5><ul>";

                    if (data.groups && data.groups.id) {
                        // groupsëŠ” ê°ì²´ í˜•íƒœë¡œ ë°˜í™˜ë˜ë¯€ë¡œ ê·¸ë£¹ì„ ê°ì²´ë¡œ ì²˜ë¦¬
                        const group = data.groups;  // ë‹¨ì¼ ê·¸ë£¹ ê°ì²´
                        html += `
                            <li>
                                <strong>ê·¸ë£¹ ì´ë¦„:</strong> ${group.group_title}
                                <div class="ms-auto p-2 bd-highlight align-self-center" style="width: 100%; text-align: end;">
                                    <button type="button" class="btn"
                                        style="background-color: #f8b739; color: white; font-weight: bold;"
                                        onclick="joinGroup('${group.id}')">
                                        ê°€ì…í•˜ê¸°
                                    </button>
                                </div>
                            </li>
                        `;
                    } else {
                        html += "<li>ğŸ”¹ í•´ë‹¹í•˜ëŠ” ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                    }

                    html += "</ul>";
                    resultDiv.innerHTML = html;

                } else {
                    resultDiv.innerHTML = "<p class='text-danger'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                }
            })
            .catch(error => {
                console.error("ì—ëŸ¬ ë°œìƒ:", error);
                document.getElementById("searchResult").innerHTML =
                    "<p class='text-danger'>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
            });
        });

        // ê·¸ë£¹ ê°€ì… ë¡œì§ ì¶”ê°€
        function joinGroup(groupId) {
            console.log("ê·¸ë£¹ ê°€ì…í•˜ê¸° ë²„íŠ¼ í´ë¦­, ê·¸ë£¹ ID:", groupId);
            
            fetch(`/groups/join/${groupId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')  // ì¸ì¦ í† í°ì´ í•„ìš”í•œ ê²½ìš°
                },
            })
            .then(response => response.json())
            .then(data => {
			    if (data.status === "success") {
			        alert(data.message);
			        // ì˜ˆ: ë²„íŠ¼ ë¹„í™œì„±í™”í•˜ê±°ë‚˜ "ê°€ì… ì™„ë£Œ"ë¡œ ë°”ê¾¸ê¸°
			    } else {
			        alert(data.message);
			    }
			})
            .catch(error => {
                console.error("ê°€ì… ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ê·¸ë£¹ ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }
    </script>
</th:block>
</html>