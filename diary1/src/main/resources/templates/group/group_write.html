<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">

<th:block layout:fragment="content">

	<!-- 그룹정보 -->
	<div class="container p-2"
		style="width: 100%; color: #000000; font-weight: bold; font-size: 20px; margin-left: 1em;"
		th:text="${group.group_title}"></div>
	<!-- 그룹정보 -->
	<!-- 목표 -->
	<div class="container-fluid mb-3">
		<table class="table">
			<caption>Group Success</caption>
			<tbody>
				<tr th:each="goal : ${goals}">
					<td scope="row" style="padding-right: 2em;"
						th:text="${goal.goal_content}">목표명</td>
					<td>
						<div th:each="date : ${dateList}" class="m-1 p-2 border rounded"
							th:classappend="${goalStatusDateMap[goal.id.toString()][date.toString()]} == true ? 'bg-success text-white' : 'bg-light'"
							th:text="${#temporals.format(date, 'MM/dd')}"></div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<!-- 목표 -->
	<!-- 글쓰기폼 -->
	<div class="container-fluid">
		<form th:action="@{|/group/${group.id}/diary/insert|}" method="post" onsubmit="return validateForm()">
			<div class="d-flex bd-highlight mb-4">
				<div class="flex-grow-1 bd-highlight" style="margin-right: 0.6em;">
					<input class="form-control form-control-lg" type="text"
						id="diary_title" name="diary_title" placeholder="제목을 입력하세요"
						aria-label="default input example">
				</div>
				<select class="form-select p-2 bd-highlight"
					aria-label="Default select example"
					style="width: 19%; margin-right: 0.6em;">
					<option selected>템플릿</option>
					<option value="1">템플릿1</option>
					<option value="2">템플릿2</option>
					<option value="3">템플릿3</option>
				</select> <select class="form-select p-2 form-select" id="openScope_insert"
					name="openScope.id" required aria-label="Default select example"
					style="width: 19%;">
					<option selected>공개범위</option>
					<option value="1">나만보기</option>
					<option value="2">친구공개</option>
					<option value="3">그룹공개</option>
					<option value="4">전체공개</option>
					<option value="5"
						th:if="${#authorization.expression('hasRole(''ADMIN'')')}">관리자작성</option>
				</select>
			</div>
			<div class="mb-3">
				<!-- <label for="exampleFormControlTextarea1" class="form-label">Example textarea</label> -->
				<textarea maxlength="500" placeholder="최대 500자" class="form-control"
					id="diary_content" name="diary_content" rows="3"
					style="width: 100%; height: 60vh; resize: none;"></textarea>
			</div>
			<button type="button" id="emojiBtn">요약받기</button>
			<div class="form-group emoji">
				<label for="diary_emoji">요약</label> <input type="text"
					name="diary_emoji" id="diary_emoji" class="form-control">
			</div>
			<div class="d-flex bd-highlight mb-4">
				<div class="p-2 bd-highlight">
					<button type="reset" class="btn p-3"
						style="width: 120%; font-size: 18px; font-weight: bold; border: 2px solid #f8b739;">취소
					</button>
				</div>
				<div class="p-2 flex-grow-1 bd-highlight">
					<button type="submit" class="btn p-3"
						style="width: 100%; font-size: 18px; font-weight: bold; background-color: #f8b739; border: 2px solid #f8b739;">게시하기
					</button>
				</div>
			</div>
		</form>
	</div>
	<!-- 글쓰기폼 -->

</th:block>
<th:block layout:fragment="jQuery">
	<script type="text/javascript">
		$(function() {
			$(".emoji").hide();
			$("#emojiBtn").on("click", function() {
				$(".emoji").fadeIn();
				let diary_content = $("#diary_content").val(); // 입력값 공백없이
				console.log(diary_content);
				if (diary_content.length > 0) { // 검색어가 공백이 아닐 때 호출
					getEmoji(diary_content);
					$(".emoji").fadeIn();
				}
			})
		});
		function getEmoji(diary_content) {
			$.ajax({
				url : "/diary/emoji",
				type : "POST",
				data : JSON.stringify({
					content : diary_content
				}),
				dataType : "json",
				contentType : "application/json;charset=UTF-8",
				error : function(zhr, status, msg) {
					console.error(status + "/" + msg);
				},
				success : function(json) {
					console.log(json);
					if (json && json.emoji && json.emoji.length > 0) {
						$("#diary_emoji").val(json.emoji);
					} // E if
				}
			});
		}
		
		function validateForm() {
			let title = document.getElementById("diary_title").value.trim();
			let content = document.getElementById("diary_content").value.trim();
			let templateSelect = document.querySelector('select.form-select:nth-of-type(1)');
			let openScopeSelect = document.getElementById("openScope_insert");

			if (title === "" || content === "") {
				alert("제목과 내용을 모두 입력해야 합니다.");
				return false;
			}

			if (templateSelect.value === "템플릿") {
				alert("템플릿을 선택해주세요.");
				return false;
			}

			if (openScopeSelect.value === "공개범위") {
				alert("공개범위를 선택해주세요.");
				return false;
			}

			return true; // 모두 통과하면 제출
		}
	</script>
</th:block>

</html>