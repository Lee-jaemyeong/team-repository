<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">

<th:block layout:fragment="content">

<script th:inline="javascript">
    /*<![CDATA[*/
    var currentUserId = /*[[${currentUserId}]]*/ 0; // 서버에서 currentUserId 값을 정확히 넣어줍니다.
    var followingIds = /*[[${followingIds}]]*/ []; // 팔로우 중인 유저 ID 목록
    var blockedUsers = /*[[${blockedUsers}]]*/ []; // 차단된 유저 ID 목록
    /*]]>*/
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- 탭 버튼 -->
<ul class="nav nav-tabs justify-content-center" id="followTab" role="tablist">
	<li class="nav-item w-50" role="presentation">
		<button class="nav-link w-100" id="follower-tab" data-bs-toggle="tab"
			data-bs-target="#follower" type="button" role="tab"
			aria-controls="follower" aria-selected="false">팔로워<span th:text="${followers != null ? followers.size() : 0}">0</span></button>
	</li>
	<li class="nav-item w-50" role="presentation">
		<button class="nav-link active w-100" id="following-tab" data-bs-toggle="tab"
			data-bs-target="#following" type="button" role="tab" aria-controls="following"
			aria-selected="true">팔로잉<span th:text="${followings != null ? followings.size():0}">0</span></button>
	</li>	
</ul>

<!-- 유저 검색 입력창 -->
<div class="container mt-3">
    <div class="input-group mb-3">
        <input type="text" id="searchUserInput" class="form-control" placeholder="유저 검색">
        <button class="btn btn-outline-secondary" id="searchUserBtn">검색</button>
    </div>
    <div id="searchResults"></div>
</div>

<!-- 탭 버튼 -->
<div class="container-fluid p-3">
	<div class="tab-content" id="followTebContent">
<!-- 팔로워 탭 -->
<div class="tab-pane fade" id="follower" role="tabpanel" aria-labelledby="follower-tab">
	<table class="table">
		<tr th:each="follow : ${followers}">
			<td>
				<div class="d-flex align-items-center">
					<div class="p-2 bd-highlight">
						<img class="rounded-circle" src="https://placehold.co/80x80">
					</div>
					<div class="p-2 flex-grow-1 bd-highlight" style="font-size: 1.2em; font-weight: bold;">
						<span th:text="${follow.follower.username}">username</span>
					</div>
					<div class="p-2 bd-highlight" th:if="${currentUserId != null}">
						<button
							class="btn follow-btn"
							th:if="${follow.follower.id != currentUserId}"
							th:attr="data-user-id=${follow.follower.id}"
							th:text="${followingIds.contains(follow.follower.id) ? '팔로잉' : '팔로우'}"
							th:class="${followingIds.contains(follow.follower.id) ? 'btn follow-btn btn-warning' : 'btn follow-btn'}"
							style="border: 2px solid #f8b739; font-weight: bold;">
						</button>
					</div>
				</div>
			</td>
		</tr>
		<!-- 팔로워가 없을 경우 메시지 출력 -->
        <tr th:if="${followers.size() == 0}">
            <td colspan="3" class="text-center">팔로워가 없습니다.</td>
        </tr>
	</table>
</div>

<!-- 팔로잉 탭 -->
<div class="tab-pane fade show active" id="following" role="tabpanel" aria-labelledby="following-tab">
	<table class="table">
		<tr th:each="follow : ${followings}">
			<td>
				<div class="d-flex align-items-center">
					<div class="p-2 bd-highlight">
						<img class="rounded-circle" src="https://placehold.co/80x80">
					</div>
					<div class="p-2 flex-grow-1 bd-highlight" style="font-size: 1.2em; font-weight: bold;">
						<span th:text="${follow.following.username}">username</span>
					</div>
					<div class="p-2 bd-highlight" th:if="${currentUserId != null}">
						<button class="btn follow-btn"
						    th:if="${follow.following.id != currentUserId}"
						    th:data-user-id="${follow.following.id}"
						    th:text="${followingIds.contains(follow.following.id) ? '팔로잉' : '팔로우'}"
						    th:classappend="${followingIds.contains(follow.following.id) ? 'btn follow-btn btn-warning' : 'btn follow-btn'}"
						    style="border: 2px solid #f8b739; font-weight: bold;">
						</button>

					</div>
				</div>
			</td>
		</tr>
		<!-- 팔로잉이 없을 경우 메시지 출력 -->
        <tr th:if="${followings.size() == 0}">
            <td colspan="3" class="text-center">팔로잉이 없습니다.</td>
        </tr>
	</table>
</div>
<!-- 팔로잉 탭 -->
	</div>
</div>

<script>
$(document).ready(function() {
    // CSRF 설정
    const csrfToken = $("meta[name='_csrf']").attr("content");
    const csrfHeader = $("meta[name='_csrf_header']").attr("content");

    if (csrfHeader && csrfToken) {
        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            }
        });
    }

    // 팔로우/언팔로우 버튼 클릭 이벤트
    $(document).on("click", ".follow-btn", function () {
        var followingId = $(this).data("user-id");
        var followerId = currentUserId;

        if (followerId === followingId) {
            alert("자기 자신을 팔로우할 수 없습니다.");
            return;
        }

        // 차단된 유저인지 확인
        if (Array.isArray(blockedUsers) && blockedUsers.includes(followingId)) {
            alert("이 유저는 차단된 유저입니다. 차단을 해제한 후 팔로우할 수 있습니다.");
            return;  // 차단된 유저일 경우 팔로우를 진행하지 않음
        }        
        
        var button = $(this);
        var isFollowing = button.text().trim() === "팔로잉";

        if (isFollowing) {
            // 언팔로우 요청
            $.ajax({
                url: "/follow",
                type: "DELETE",
                data: { followerId, followingId },
                cache: false,
                success: function() {
                    alert("언팔로우 성공!");

                    // 팔로잉 목록에서 해당 유저의 정보를 제거
                    button.text("팔로우");
                    button.removeClass("btn-warning");
                    button.css({
                        "background-color": "",
                        "color": "",
                        "border": "2px solid #f8b739"
                    });

                    // followingIds에서 제거
                    if (Array.isArray(followingIds)) {
                        followingIds = followingIds.filter(id => id !== followingId);
                    }

                    // 팔로잉 리스트 갱신
                    updateFollowingList();
                    updateSearchResults(followingId, "팔로우");
                },
                error: function() {
                    alert("언팔로우 실패");
                }
            });
        } else {
            // 팔로우 요청
            $.ajax({
                url: "/follow",
                type: "POST",
                data: { followerId, followingId },
                success: function() {
                    alert("팔로우 성공!");
                    button.text("팔로잉");
                    button.addClass("btn-warning");
                    button.css({
                        "background-color": "#f8b739",
                        "color": "",
                        "border": "2px solid #f8b739"
                    });

                    // followingIds에 추가
                    if (Array.isArray(followingIds)) {
                        followingIds.push(followingId);
                    }

                    // 팔로잉 리스트 갱신
                    updateFollowingList();
                    updateSearchResults(followingId, "팔로잉");
                },
                error: function() {
                    alert("팔로우 실패");
                }
            });
        }
    });

    // 검색결과의 팔로우/언팔로우 버튼 클릭
    $(document).on("click", ".follow-search-btn", function () {
        const followingId = $(this).data("user-id");
        const followerId = currentUserId;

        if (followerId === followingId) {
            alert("자기 자신은 팔로우할 수 없습니다.");
            return;
        }

        // 차단된 유저인지 확인
        if (Array.isArray(blockedUsers) && blockedUsers.includes(followingId)) {
            alert("이 유저는 차단된 유저입니다. 차단을 해제한 후 팔로우할 수 있습니다.");
            return;  // 차단된 유저일 경우 팔로우를 진행하지 않음
        }        
        
        const btn = $(this);
        const isFollowing = btn.text().trim() === "팔로잉";

        // followingIds 배열에 이미 포함되어 있으면 중복 팔로우 방지
        if (!isFollowing && followingIds.includes(followingId)) {
            alert("이미 팔로우 중입니다.");
            return;
        }

        if (isFollowing) {
            // 언팔로우 요청
            $.ajax({
                url: "/follow",
                type: "DELETE",
                data: { followerId, followingId },
                success: function () {
                    alert("언팔로우 성공!");
                    btn.text("팔로우")
                       .removeClass("btn-warning")
                       .addClass("btn-outline-warning");

                    // followingIds에서 제거
                    if (Array.isArray(followingIds)) {
                        followingIds = followingIds.filter(id => id !== followingId);
                    }
                    // 팔로잉 목록 갱신
                    updateFollowingList();
                    // 검색 결과의 팔로잉 상태도 업데이트
                    updateSearchResults(followingId, "팔로우");
                },
                error: function () {
                    alert("언팔로우 실패");
                }
            });
        } else {
            // 팔로우 요청
            $.ajax({
                url: "/follow",
                type: "POST",
                data: { followerId, followingId },
                success: function () {
                    alert("팔로우 성공!");
                    btn.text("팔로잉")
                       .removeClass("btn-outline-warning")
                       .addClass("btn-warning");

                    // followingIds에 추가
                    followingIds.push(followingId);
                    // 팔로잉 목록 갱신
                    updateFollowingList();
                    // 검색 결과의 팔로잉 상태도 업데이트
                    updateSearchResults(followingId, "팔로잉");
                },
                error: function () {
                    alert("팔로우 실패");
                }
            });
        }
    });

    // 검색 결과의 팔로잉 버튼 상태를 업데이트하는 함수
    function updateSearchResults(userId, status) {
        const searchResultItems = $("#searchResults").find(".follow-search-btn");
        searchResultItems.each(function () {
            const btn = $(this);
            if (btn.data("user-id") === userId) {
                if (status === "팔로잉") {
                    btn.text("팔로잉")
                       .removeClass("btn-outline-warning")
                       .addClass("btn-warning");
                } else {
                    btn.text("팔로우")
                       .removeClass("btn-warning")
                       .addClass("btn-outline-warning");
                }
            }
        });
    }

    // 팔로잉 목록을 갱신하는 함수
    function updateFollowingList() {
        $.ajax({
            url: "/follow/following",
            type: "GET",
            data: { userId: currentUserId }, // 현재 사용자 ID로 팔로잉 목록을 요청
            success: function(followings) { 
                var html = "<table class='table'>";
                if (followings.length === 0) {
                    html += "<tr><td colspan='3' class='text-center'>팔로잉이 없습니다.</td></tr>";
                } else {
                    followings.forEach(following => {
                        html += `
                            <tr>
                                <td>
	                                <div class="d-flex align-items-center">
		                                <div class="p-2 bd-highlight">
		                                    <img class="rounded-circle" src="https://placehold.co/80x80">
		                                </div>
		                                <div class="p-2 flex-grow-1 bd-highlight" style="font-size: 1.2em; font-weight: bold;">
		                                    <span>${following.username}</span>
		                                </div>
		                                <div class="p-2 bd-highlight">
		                                    <button class="btn follow-btn btn-warning"
		                                            data-user-id="${following.id}"
		                                            style="border: 2px solid #f8b739; font-weight: bold;">
		                                        팔로잉
		                                    </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
                    });
                }
                html += "</table>";
                $("#following").html(html);  // 팔로잉 탭의 내용을 갱신
            },
            error: function() {
                alert("팔로잉 목록을 갱신하는 데 실패했습니다.");
            }
        });
    }

    // followingIds가 null 또는 undefined일 경우 빈 배열로 초기화
    var followingIds = followingIds || [];  // followingIds가 null이나 undefined이면 빈 배열로 초기화    
    
    // 검색 버튼 클릭
    $("#searchUserBtn").click(function () {
        const keyword = $("#searchUserInput").val().trim();
        const currentUserId = /*[[${currentUserId}]]*/ 0;
        
        if (!keyword) return;

        $.ajax({
            url: "/search/users",
            type: "GET",
            data: {
                keyword: keyword,
                currentUserId: currentUserId // currentUserId 값이 여기로 전달됩니다.
            },
            success: function(users) {
                let html = "<ul class='list-group'>";
                if (users.length === 0) {
                    html += "<li class='list-group-item'>검색 결과가 없습니다.</li>";
                } else {
                    // 차단된 유저를 클라이언트에서 다시 필터링할 수 있음
                    const filteredUsers = users.filter(user => !blockedUsers.includes(user.id));

                    // 검색된 유저 출력
                    filteredUsers.forEach(user => {
                        const isFollowing = followingIds.includes(user.id);
                        const buttonText = isFollowing ? "팔로잉" : "팔로우";
                        html += `
                            <li class='list-group-item d-flex justify-content-between align-items-center'>
                                <span>${user.username}</span>
                                <button class="btn follow-search-btn ${isFollowing ? 'btn-warning' : 'btn-outline-warning'}"
                                        data-user-id="${user.id}">${buttonText}</button>
                            </li>`;
                    });
                }
                html += "</ul>";
                $("#searchResults").html(html);
            },
            error: function() {
                alert("검색 실패");
            }
        });
    });
});

</script>

</th:block>

</html>
